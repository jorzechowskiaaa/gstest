<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <actionCalls>
        <name>Calculate_Mileage</name>
        <label>Calculate Mileage</label>
        <locationX>842</locationX>
        <locationY>815</locationY>
        <actionName>FSL_MileageCalculatedUtility</actionName>
        <actionType>apex</actionType>
        <flowTransactionModel>CurrentTransaction</flowTransactionModel>
        <inputParameters>
            <name>destinationLatitude</name>
            <value>
                <elementReference>DestinationLatitude</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>destinationLongitude</name>
            <value>
                <elementReference>DestinationLongitude</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>originLatitude</name>
            <value>
                <elementReference>OriginLatitude</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>originLongitude</name>
            <value>
                <elementReference>OriginLongitude</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>productCode</name>
            <value>
                <stringValue>CE</stringValue>
            </value>
        </inputParameters>
        <inputParameters>
            <name>workOrderId</name>
            <value>
                <elementReference>$Record.Work_Order__c</elementReference>
            </value>
        </inputParameters>
        <nameSegment>FSL_MileageCalculatedUtility</nameSegment>
    </actionCalls>
    <apiVersion>53.0</apiVersion>
    <areMetricsLoggedToDataCloud>false</areMetricsLoggedToDataCloud>
    <assignments>
        <name>Assign_Destination_Latitude_Longitude</name>
        <label>Assign Destination Latitude Longitude</label>
        <locationX>974</locationX>
        <locationY>575</locationY>
        <assignmentItems>
            <assignToReference>DestinationLatitude</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.FSL__InternalSLRGeolocation__Latitude__s</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>DestinationLongitude</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.FSL__InternalSLRGeolocation__Longitude__s</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Check_For_Both_Origin_and_Destination_Latitude_Longitude</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Assign_Lat_Long_from_Service_Territory</name>
        <label>Assign Lat Long from Service Territory</label>
        <locationX>974</locationX>
        <locationY>455</locationY>
        <assignmentItems>
            <assignToReference>OriginLatitude</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.ServiceTerritory.FSL__Internal_SLR_Geolocation__Latitude__s</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>OriginLongitude</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.ServiceTerritory.FSL__Internal_SLR_Geolocation__Longitude__s</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Assign_Destination_Latitude_Longitude</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Assign_Resource_Longitude_Latitude</name>
        <label>Assign Resource Longitude Latitude</label>
        <locationX>182</locationX>
        <locationY>815</locationY>
        <assignmentItems>
            <assignToReference>OriginLatitude</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>get_Service_Resource_Record.LastKnownLatitude</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>OriginLongitude</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>get_Service_Resource_Record.LastKnownLongitude</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Get_Service_Appointment_Status_Location_Record</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Assigned_Driver_Service_Coordinate</name>
        <label>Assigned Driver Service Coordinate</label>
        <locationX>50</locationX>
        <locationY>1175</locationY>
        <assignmentItems>
            <assignToReference>Get_Service_Appointment_Status_Location_Record.From_Latitude__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>OriginLatitude</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>Get_Service_Appointment_Status_Location_Record.From_Longitude__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>OriginLongitude</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Update_Driver_Coordinate_Location</targetReference>
        </connector>
    </assignments>
    <decisions>
        <name>Check_Calculate_Mileage_Option</name>
        <label>Check Calculate Mileage Option</label>
        <locationX>875</locationX>
        <locationY>335</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Driver_Base_Location</name>
            <conditionLogic>or</conditionLogic>
            <conditions>
                <leftValueReference>$Record.ServiceTerritory.Enable_Calculate_Mileage__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>From Driver Location</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Get_Time_Limit_Configuration</targetReference>
            </connector>
            <label>Driver Base Location</label>
        </rules>
        <rules>
            <name>Service_Territory_Base_Location</name>
            <conditionLogic>or</conditionLogic>
            <conditions>
                <leftValueReference>$Record.ServiceTerritory.Enable_Calculate_Mileage__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>From Service Territory</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.ServiceTerritory.Enable_Calculate_Mileage__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Not Calculated Facility</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Assign_Lat_Long_from_Service_Territory</targetReference>
            </connector>
            <label>Service Territory Base Location</label>
        </rules>
    </decisions>
    <decisions>
        <name>Check_For_Both_Origin_and_Destination_Latitude_Longitude</name>
        <label>Check For Both Origin and Destination Latitude Longitude</label>
        <locationX>974</locationX>
        <locationY>695</locationY>
        <defaultConnector>
            <targetReference>Create_Application_Log_0</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Available_Both_Lat_and_Long</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>OriginLatitude</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>OriginLongitude</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>DestinationLatitude</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>DestinationLatitude</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Calculate_Mileage</targetReference>
            </connector>
            <label>Available Both Lat and Long</label>
        </rules>
    </decisions>
    <decisions>
        <name>Check_If_Service_Appointment_Status_Location_Exist</name>
        <label>Check If Service Appointment Status Location Exist</label>
        <locationX>182</locationX>
        <locationY>1055</locationY>
        <defaultConnector>
            <targetReference>Insert_Driver_Coordinate_Location</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Exist_EnRoute_Clear_Record</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Get_Service_Appointment_Status_Location_Record</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Assigned_Driver_Service_Coordinate</targetReference>
            </connector>
            <label>Exist EnRoute Clear Record</label>
        </rules>
    </decisions>
    <decisions>
        <name>Check_Resource_Last_Location</name>
        <label>Check Resource Last Location</label>
        <locationX>380</locationX>
        <locationY>575</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Service_Resource_Has_Lat_Long</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.Service_Resource__r.LastKnownLatitude</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.Service_Resource__r.LastKnownLongitude</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.Service_Resource__r.LastKnownLocationDate</leftValueReference>
                <operator>GreaterThanOrEqualTo</operator>
                <rightValue>
                    <elementReference>AcceptableLastKnownLocationUpdateTime</elementReference>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>get_Service_Resource_Record</targetReference>
            </connector>
            <label>Service Resource Has Lat_Long</label>
        </rules>
    </decisions>
    <formulas>
        <name>AcceptableLastKnownLocationUpdateTime</name>
        <dataType>DateTime</dataType>
        <expression>{!$Flow.CurrentDateTime} - ({!SR_LastUpdateAcceptableGapInMinute}/1440)</expression>
    </formulas>
    <formulas>
        <name>CalculateTowMileage</name>
        <dataType>Number</dataType>
        <expression>DISTANCE(GEOLOCATION({!OriginLatitude},{!OriginLongitude}),GEOLOCATION({!DestinationLatitude},{!DestinationLongitude}),&#39;mi&#39;)</expression>
        <scale>2</scale>
    </formulas>
    <interviewLabel>FSL Mileage Calculation {!$Flow.CurrentDateTime}</interviewLabel>
    <label>FSL Mileage Calculation</label>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>AUTO_LAYOUT_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordCreates>
        <description>Create application for failure</description>
        <name>Create_Application_Log_0</name>
        <label>Create Application Log</label>
        <locationX>1106</locationX>
        <locationY>815</locationY>
        <inputAssignments>
            <field>Error_Caught__c</field>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Error_Message__c</field>
            <value>
                <stringValue>Missing complete Lat/Long</stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Operation__c</field>
            <value>
                <stringValue>CalculatedMileage</stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Service_Appointment__c</field>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Work_Order__c</field>
            <value>
                <elementReference>$Record.Work_Order__c</elementReference>
            </value>
        </inputAssignments>
        <object>FSL_Application_Log__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordCreates>
    <recordCreates>
        <name>Insert_Driver_Coordinate_Location</name>
        <label>Insert Driver Coordinate Location</label>
        <locationX>314</locationX>
        <locationY>1175</locationY>
        <connector>
            <targetReference>Assign_Destination_Latitude_Longitude</targetReference>
        </connector>
        <inputAssignments>
            <field>End_States__c</field>
            <value>
                <stringValue>ER - Cancelled_Cleared</stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>From_Latitude__c</field>
            <value>
                <elementReference>OriginLatitude</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>From_Longitude__c</field>
            <value>
                <elementReference>OriginLongitude</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Service_Appointment__c</field>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Work_Order__c</field>
            <value>
                <elementReference>$Record.Work_Order__c</elementReference>
            </value>
        </inputAssignments>
        <object>Service_Appointment_Status_Location__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordCreates>
    <recordLookups>
        <name>Get_Service_Appointment_Status_Location_Record</name>
        <label>Get Service Appointment Status Location Record</label>
        <locationX>182</locationX>
        <locationY>935</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Check_If_Service_Appointment_Status_Location_Exist</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>End_States__c</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>ER - Cancelled_Cleared</stringValue>
            </value>
        </filters>
        <filters>
            <field>Work_Order__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.Work_Order__c</elementReference>
            </value>
        </filters>
        <filters>
            <field>Service_Appointment__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Service_Appointment_Status_Location__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>get_Service_Resource_Record</name>
        <label>get Service Resource Record</label>
        <locationX>182</locationX>
        <locationY>695</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Assign_Resource_Longitude_Latitude</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.Service_Resource__r.Id</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>ServiceResource</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Get_Time_Limit_Configuration</name>
        <label>Get Time Limit Configuration</label>
        <locationX>380</locationX>
        <locationY>455</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Check_Resource_Last_Location</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>DeveloperName</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Driver_Location_Last_Update_In_Minute</stringValue>
            </value>
        </filters>
        <object>Time_Limit_Configuration__mdt</object>
        <outputAssignments>
            <assignToReference>SR_LastUpdateAcceptableGapInMinute</assignToReference>
            <field>Number_Of_Minutes__c</field>
        </outputAssignments>
    </recordLookups>
    <recordUpdates>
        <name>Update_Driver_Coordinate_Location</name>
        <label>Update Driver Coordinate Location</label>
        <locationX>50</locationX>
        <locationY>1295</locationY>
        <connector>
            <targetReference>Assign_Destination_Latitude_Longitude</targetReference>
        </connector>
        <inputReference>Get_Service_Appointment_Status_Location_Record</inputReference>
    </recordUpdates>
    <start>
        <locationX>749</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>Check_Calculate_Mileage_Option</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Status</field>
            <operator>IsChanged</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <filters>
            <field>Status</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>En Route</stringValue>
            </value>
        </filters>
        <filters>
            <field>Subject</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Breakdown Appointment</stringValue>
            </value>
        </filters>
        <object>ServiceAppointment</object>
        <recordTriggerType>Update</recordTriggerType>
        <triggerType>RecordAfterSave</triggerType>
    </start>
    <status>Obsolete</status>
    <variables>
        <name>DestinationLatitude</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>9</scale>
    </variables>
    <variables>
        <name>DestinationLongitude</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>9</scale>
    </variables>
    <variables>
        <name>OM_Product_Record</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Product2</objectType>
    </variables>
    <variables>
        <name>OriginLatitude</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>9</scale>
    </variables>
    <variables>
        <name>OriginLongitude</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>9</scale>
    </variables>
    <variables>
        <name>SR_LastUpdateAcceptableGapInMinute</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>0</scale>
        <value>
            <numberValue>0.0</numberValue>
        </value>
    </variables>
</Flow>
