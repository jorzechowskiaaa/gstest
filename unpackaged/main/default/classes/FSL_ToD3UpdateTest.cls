/**
 * @File Name          : FSL_ToD3UpdateTest.cls
 * @Description        : 
 * @Author             : Rajesh Kemisetti
 * @Group              : 
 * @Last Modified By   : ChangeMeIn@UserSettingsUnder.SFDoc
 * @Last Modified On   : 12-14-2020
 * @Modification Log   : 
 * Ver       Date            Author      		    Modification
 * 1.0    4/16/2020   Rajesh Kemisetti     Initial Version
**/
@isTest
private class FSL_ToD3UpdateTest {    
    static User user = new User();
    static String body = '';
    static Map<String, String> responseHeaders = new Map<String, String>{'Content-Type' => 'application/json;charset=UTF-8'};
        
    static testMethod void loadWorkOrdersTest(){            
        FSL_DataFactory.createWOIntakeCall('FSL_LightCall');
        System.Test.StartTest();
                         
            FSL_Service_Endpoints__c endpoint = new FSL_Service_Endpoints__c(); // Added this custom setting as required for makePostCallout method.
            endpoint.Endpoint_URL__c ='org_id=81511&foreign_id=';
            endpoint.client_id__c = '1qe4s3snv71lu6j301urnvblgv';
            endpoint.Client_Secret__c = 'ku4ufh1ig5corgjjbbk1chmbkknk6ke3e9sqj2im2o0p9qlkhr9';
            endpoint.Client_Cert_Name__c = 'ace_fsl_uat';
            endpoint.Timeout__c = 20000;
            endpoint.Named_Credential__c = 'OAuth';
            endpoint.Name='OAuth';
            insert endpoint;
            
            List<WorkOrder> workOrderList = [Select Id, (select id, SchedStartTime, SchedEndTime, actualstarttime, PTA__c from ServiceAppointments) from WorkOrder];
            ServiceResource serviceResource = [select id, Primary_Service_Territory__c, Primary_Service_Territory__r.OperatingHoursId from serviceresource where ResourceType='T' limit 1];
            list<ServiceAppointment> SAList = new list<ServiceAppointment>();
            list<AssignedResource> ARList = new list<AssignedResource>();
            for(workOrder wo : workOrderList){
                wo.ServiceAppointments[0].SchedStartTime = System.now();
                wo.ServiceAppointments[0].SchedEndTime = System.now()+1800;
                wo.ServiceAppointments[0].actualstarttime = System.now();
                wo.ServiceAppointments[0].PTA__c = System.now();
                SAList.add(wo.ServiceAppointments[0]); 
                
                AssignedResource assignedResource = FSL_DataFactory.createAssignedResource(wo.ServiceAppointments[0].Id, serviceResource.Id);
                ARList.add(assignedResource);
            }
            
            update SAList;
            insert ARList;
            
            workOrderList[0].ServiceAppointments[0].status = 'En Route';
            update workOrderList[0].ServiceAppointments[0];
            
            Test.setMock(HttpCalloutMock.class, new FSL_WOJeopardy_MockResponseGenerator(false));          
            
        	body = '{ "id" : "b45d456a-3bd4-4f73-92b5-547b603bcd07", "requestEventType" : "CLEAR", "subType" : "CLEAR", "status" : "UNUSED", "version" : "1.0.0", "sourceSystem" : { "systemId" : "AAAD3Test", "systemOrganization" : { "name" : "AAA", "code" : "014" } }, "targetSystem" : { "systemId" : "SLTest", "systemOrganization" : { "name" : "Salesforce", "code" : "014" } }, "createDate" : 1539736591270, "calls" : [ { "callKey" : "014-20180915-30000", "callDate" : "2018-09-15", "callId" : 30000, "version" : "1", "channel" : { "channelType" : "CALL_CENTER", "org" : { "name" : "HEATHROW", "code" : "HEA" }, "contact" : { "userId" : "JDC1234", "contactType" : "AGENT" }, "location" : { "latitude" : 28.769527, "longitude" : -81.362267, "address" : { "addressType" : "PHYSICAL", "full" : "1000 AAA DR, LAKE MARY, FL 32725", "streetNumber" : "1000", "streetDirection" : "EAST", "streetName" : "AAA DR", "crossStreet" : "INTERNATIONAL PKWY", "city" : "LAKE MARY", "county" : "SEMINOLE", "state" : "FL", "postalCode" : "32746", "country" : "UNITED STATES" } } }, "customer" : { "memberships" : [ { "membershipType" : "VIP", "sponsor" : "LINCOLN", "program" : "BLACK LABEL", "authorizationCode" : "1234534523", "authorizationLevel" : "123", "isLocalClub" : true, "org" : { "name" : "Auto Club Group", "code" : "014" }, "id" : "1234567890123456", "originalMemberId" : "1234567890123456", "expirationDate" : "2018-10-01", "memberLevel" : "PREMIERE", "memberBirthday" : "1978-09-15", "memberSince" : "1994", "memberStatus" : "ACTIVE", "entitlements" : [ { "serviceChargeIndicator" : false } ] } ], "contact" : { "contactType" : "CUSTOMER", "title" : "MR", "firstName" : "STEVE", "lastName" : "JONES", "phones" : [ { "phoneType" : "CELLULAR", "phoneNumber" : "1234567890", "phoneExtension" : "456", "preferred" : true, "smsOptIn" : true } ], "emails" : [ { "emailType" : "PERSONAL", "address" : "someuser@foobar.com" } ] }, "languagePreference" : "ENGLISH" }, "vehicle" : { "vehicleType" : "PS", "year" : 2012, "make" : "HONDA", "model" : "ACCORD", "trim" : "RX", "color" : "BLUE", "driveType" : "FW", "vin" : "432143124124E234", "tag" : "N12ABC", "state" : "FL", "odometer" : 78310, "fuelType" : "GAS", "rvInfo" : { "rvClass" : "A", "engineLocation" : "REAR", "gooseNeck" : false, "height" : 15.5, "length" : 24.2, "weight" : 1055, "towing" : false, "towingType" : "NOT TOWING" }, "trailerInfo" : { "axles" : 2, "condition" : "GOOD", "gooseNeck" : true, "hitchSize" : 3.5, "hitchType" : "BALL", "length" : 35.6, "loaded" : "????", "loadType" : "WATER", "loadWeight" : "1000", "plugType" : "7 PIN", "trailerType" : "5TH WHEEL" }, "specialEquipmentNeeds" : "NEED A BIG JACK" }, "service" : { "callType" : "MEMBER", "timezoneId" : "America/New_York", "timezoneOffset" : "UTC-07:00", "status" : { "status" : "SP", "modifiedDate" : "2018-09-15T10:05:21Z[UTC]", "eta" : "2018-09-15T10:05:41Z[UTC]", "pta" : "2018-09-15T10:05:51Z[UTC]", "waitTime" : 30 }, "appointmentTime" : "2018-09-15T10:05:51Z[UTC]", "facility" : { "foiType" : "ERS", "location" : { }, "id" : "9193", "name" : "BOBS TOWING ORLANDO SOUTH" }, "truck" : { "id" : "B1", "driver" : { "id" : "123", "contact" : { "contactType" : "DRIVER", "lastName" : "Truckdriver" } } }, "troubleCodes" : [ { "troubleCodeType" : "PACESETTER", "code" : "T680", "description" : "Engine Stalled While Driving" }, { "troubleCodeType" : "PACESETTER2", "code" : "T505", "description" : "L505 Parking Brake Wont Release" }, { "troubleCodeType" : "PROBLEM", "code" : "T6", "description" : "ENGINE STALLED" }, { "troubleCodeType" : "PROBLEM2", "code" : "T9", "description" : "PARKING BRAKE" } ], "serviceLocations" : [ { "serviceLocationType" : "BREAKDOWN", "foi" : { "foiType" : "ADDRESS", "location" : { "latitude" : 28.53349, "longitude" : -81.37751, "address" : { "addressType" : "PHYSICAL", "full" : "700 MAIN LANE, ORLANDO FL, 32801", "streetNumber" : "700", "streetDirection" : "SW", "streetName" : "MAIN LANE", "crossStreet" : "LUCERNE CIRCLE SW", "crossStreet2" : "HIGHWAY TO SOMEWHERE", "city" : "ORLANDO", "county" : "MONROE", "state" : "FL", "postalCode" : "32801", "country" : "UNITED STATES" }, "landmark" : "BOBS DINER", "highway" : "I-4", "mileMarker" : "47", "grid" : "B23", "zone" : "A1", "locationCode" : "BR" } }, "mileageCalculated" : 25, "driverDirections" : "GATECODE IS 12345" }, { "serviceLocationType" : "TOW_DESTINATION", "foi" : { "foiType" : "ADDRESS", "location" : { "latitude" : 26.98492, "longitude" : -82.10246, "address" : { "addressType" : "PHYSICAL", "full" : "3156 TAMIAMI TR, PORT CHARLOTTE, FL 33952", "streetNumber" : "3156", "streetName" : "TAMIAMI TR", "crossStreet" : "OCEAN BOULEVARD", "city" : "PORT CHARLOTTE", "county" : "PINELLAS", "state" : "FL", "postalCode" : "33952", "country" : "UNITED STATES" }, "landmark" : "AAR DON GASGARTHS CHARLOTTE CO FORD" }, "name" : "AAA DON GASGARTH CHARLOTTE CO FORD", "contacts" : [ { "contactType" : "TOWDEST", "firstName" : "BOB", "lastName" : "SHMOE", "phones" : [ { "phoneType" : "BUSINESS", "phoneNumber" : "8889996666", "preferred" : true } ] } ] }, "mileageCalculated" : 18, "dropBoxInfo" : "FACILITY DROPBOX IS LOCATED IN FRONT BY DOOR" } ], "collision" : false, "redFlag" : false, "priorityCode" : "P1", "legacyPriorityCode" : "P1", "numberOfPassengers" : 2, "needsFlatbed" : false, "flatbedRequested" : true, "policies" : [ { "code" : "POL1", "description" : "Service Policy1" } ], "providedServices" : [ { "providedServiceType" : "EXTRA CHARGE", "service" : "LONG TOW", "unit" : "MILES", "quantity" : 10, "charge" : { "chargeType" : "SERVICE_PROVIDED", "amount" : "5.00" } }, { "providedServiceType" : "", "service" : "GAS DELIVERY", "unit" : "GALLONS", "quantity" : 5 } ], "charges" : [ { "chargeType" : "GAS", "amount" : "10.00" } ] }, "payment" : { "required" : true, "paymentType" : "CREDIT", "codes" : "SOME PAYMENT CODES GO HERE" }, "comments" : [ { "system" : { "systemId" : "AAAD3Test", "systemOrganization" : { "name" : "AAA", "code" : "014" } }, "contact" : { "userId" : "ab5678", "contactType" : "AGENT" }, "commentDate" : "2018-09-15T10:05:20Z[UTC]", "commentType" : "CALL", "visibility" : "EXTERNAL", "text" : "THIS IS A COMMENT ABOUT THIS CALL VISIBLE TO ALL USERS" } ] } ] }';
            System.Test.setMock(HttpCalloutMock.class, new FSL_ToD3UpdateCalloutMockImpl(200, 'OK', body, responseHeaders));
            FSL_ToD3Update.loadWorkOrders(New Set<ID>{workOrderList[0].Id, workOrderList[0].id} );            
        System.Test.StopTest();     
    }
    
    static testMethod void makePostCalloutTest(){
        
        string jsonReq = '{"id":"7051b8d9-1076-4bc9-82c2-0d50a30cc7d6","requestEventType":"UPDATE","subType":"UPDATE","status":"UNUSED","version":"1.0.0","sourceSystem":{"systemId":"AAAD3Test","systemOrganziation":{"name":"AAA","code":"014"}},"targetSystem":{"systemId":"SLTest","systemOrganziation":{"name":"Salesforce","code":"014"}},"createDate":1538566964227,"calls":[{"callKey":"014-20180915-30000","callDate":"2018-09-15","callId":30000,"version":"1","channel":{"channelType":"CALL_CENTER","org":{"name":"HEATHROW","code":"HEA"},"contact":{"userId":"JDC1234","contactType":"AGENT"},"location":{"latitude":28.769527,"longitude":-81.362267,"address":{"addressType":"PHYSICAL","full":"1000 AAA DR, LAKE MARY, FL 32725","streetNumber":"1000","streetDirection":"EAST","streetName":"AAA DR","crossStreet":"INTERNATIONAL PKWY","city":"LAKE MARY","county":"SEMINOLE","state":"FL","postalCode":"32746","country":"UNITED STATES"}}},"customer":{"memberships":[{"membershipType":"VIP","sponsor":"LINCOLN","program":"BLACK LABEL","authorizationCode":"1234534523","authorizationLevel":"123","isLocalClub":true,"org":{"name":"Auto Club Group","code":"014"},"id":"1234567890123456","expirationDate":"2018-10-01","memberLevel":"PREMIERE","memberBirthday":"1978-09-15","memberSince":"1994","memberStatus":"ACTIVE","entitlements":[{"serviceChargeIndicator":false}]}],"contact":{"contactType":"CUSTOMER","title":"MR","firstName":"STEVE","lastName":"JONES","phones":[{"phoneType":"CELLULAR","phoneNumber":"1234567890","phoneExtension":"456","preferred":true,"smsOptIn":true}],"emails":[{"emailType":"PERSONAL","address":"someuser@foobar.com"}]},"languagePreference":"ENGLISH"},"vehicle":{"vehicleType":"PS","year":2012,"make":"HONDA","model":"ACCORD","trim":"RX","color":"BLUE","driveType":"FW","vin":"432143124124E234","tag":"N12ABC","state":"FL","odometer":78310,"fuelType":"GAS","rvInfo":{"rvClass":"A","engineLocation":"REAR","gooseNeck":false,"height":15.5,"length":24.2,"weight":1055,"towing":false,"towingType":"NOT TOWING"},"trailerInfo":{"axles":2,"condition":"GOOD","gooseNeck":true,"hitchSize":3.5,"hitchType":"BALL","length":35.6,"loaded":"????","loadType":"WATER","loadWeight":"1000","plugType":"7 PIN","trailerType":"5TH WHEEL"},"specialEquipmentNeeds":"NEED A BIG"},"service":{"callType":"MEMBER","timezoneId":"America/New_York","timezoneOffset":"UTC-07:00","status":{"status":"SP","modifiedDate":"2018-09-15T10:05:21Z[UTC]","eta":"2018-09-15T10:05:41Z[UTC]","pta":"2018-09-15T10:05:51Z[UTC]","waitTime":30},"appointmentTime":"2018-09-15T10:05:51Z[UTC]","facility":{"foiType":"ERS","location":{},"id":"9193","name":"BOBS TOWING ORLANDO SOUTH"},"troubleCodes":[{"troubleCodeType":"PACESETTER","code":"T680","description":"Engine Stalled While Driving"},{"troubleCodeType":"PACESETTER2","code":"T505","description":"L505 Parking Brake Wont Release"},{"troubleCodeType":"PROBLEM","code":"T6","description":"ENGINE STALLED"},{"troubleCodeType":"PROBLEM2","code":"T9","description":"PARKING BRAKE"}],"serviceLocations":[{"serviceLocationType":"BREAKDOWN","foi":{"foiType":"ADDRESS","location":{"latitude":28.53349,"longitude":-81.37751,"address":{"addressType":"PHYSICAL","full":"700 MAIN LANE, ORLANDO FL, 32801","streetNumber":"700","streetDirection":"SW","streetName":"MAIN LANE","crossStreet":"LUCERNE CIRCLE SW","crossStreet2":"HIGHWAY TO SOMEWHERE","city":"ORLANDO","county":"MONROE","state":"FL","postalCode":"32801","country":"UNITED STATES"},"highway":"I-4","mileMarker":"47","grid":"B23","zone":"A1","locationCode":"BR"}},"mileageCalculated":25,"driverDirections":"GATECODE IS 12345"},{"serviceLocationType":"TOW_DESTINATION","foi":{"foiType":"ADDRESS","location":{"latitude":26.98492,"longitude":-82.10246,"address":{"addressType":"PHYSICAL","full":"3156 TAMIAMI TR, PORT CHARLOTTE, FL 33952","streetNumber":"3156","streetName":"TAMIAMI TR","crossStreet":"OCEAN BOULEVARD","city":"PORT CHARLOTTE","county":"PINELLAS","state":"FL","postalCode":"33952","country":"UNITED STATES"},"landmark":"AAR DON GASGARTHS CHARLOTTE CO FORD"},"name":"AAA DON GASGARTH CHARLOTTE CO FORD","contacts":[{"contactType":"TOWDEST","firstName":"BOB","lastName":"SHMOE","phones":[{"phoneType":"BUSINESS","phoneNumber":"8889996666","preferred":true}]}]},"mileageCalculated":18,"dropBoxInfo":"FACILITY DROPBOX IS LOCATED IN FRONT BY DOOR"}],"collision":false,"redFlag":false,"priorityCode":"P1","numberOfPassengers":2,"needsFlatbed":false,"flatbedRequested":true,"policies":[{"code":"POL1","description":"Service Policy1"}]},"payment":{"required":true,"paymentType":"CREDIT","codes":"SOME PAYMENT CODES GO HERE"},"comments":[{"system":{"systemId":"AAAD3Test","systemOrganziation":{"name":"AAA","code":"014"}},"contact":{"userId":"ab5678","contactType":"AGENT"},"commentDate":"2018-09-15T10:05:20Z[UTC]","commentType":"CALL","visibility":"EXTERNAL","text":"THIS IS A COMMENT ABOUT THIS CALL VISIBLE TO ALL USERS"}]}]}';

        List<User> users = [SELECT Id FROM user WHERE alias = 'C_Admin'];
        PermissionSet pset = [SELECT Id FROM PermissionSet WHERE Name = 'Skip_Sharing_Logic'][0];

        insert new PermissionSetAssignment(AssigneeId=users[0].Id, PermissionSetId=pset.Id); 
        System.runAs( users[0] ) {
            System.Test.StartTest();
            
            FSL_Service_Endpoints__c endpoint = new FSL_Service_Endpoints__c(); //// Added this custom setting as required for makePostCallout method.
            endpoint.Endpoint_URL__c ='org_id=81511&foreign_id=';
            endpoint.client_id__c = '1qe4s3snv71lu6j301urnvblgv';
            endpoint.Client_Secret__c = 'ku4ufh1ig5corgjjbbk1chmbkknk6ke3e9sqj2im2o0p9qlkhr9';
            endpoint.Client_Cert_Name__c = 'ace_fsl_uat';
            endpoint.Timeout__c = 20000;
            endpoint.Named_Credential__c = 'OAuth';
            endpoint.Name='OAuth';
            insert endpoint;
            
            FSL_DataFactory.createWOIntakeCall('FSL_LightCall');
            List<WorkOrder> workOrderList = [Select Id, (select id, SchedStartTime, SchedEndTime, actualstarttime, PTA__c from ServiceAppointments) from WorkOrder];
            ServiceResource serviceResource = [select id, Primary_Service_Territory__c, Primary_Service_Territory__r.OperatingHoursId from serviceresource where ResourceType='T' limit 1];
            list<ServiceAppointment> SAList = new list<ServiceAppointment>();
            list<AssignedResource> ARList = new list<AssignedResource>();
            for(workOrder wo : workOrderList){
                wo.ServiceAppointments[0].SchedStartTime = System.now();
                wo.ServiceAppointments[0].SchedEndTime = System.now()+1800;
                wo.ServiceAppointments[0].actualstarttime = System.now();
                wo.ServiceAppointments[0].PTA__c = System.now();
                SAList.add(wo.ServiceAppointments[0]); 
                
                AssignedResource assignedResource = FSL_DataFactory.createAssignedResource(wo.ServiceAppointments[0].Id, serviceResource.Id);
                ARList.add(assignedResource);
            }
            
            update SAList;
            insert ARList;
            
            Test.setMock(HttpCalloutMock.class, new FSL_WOJeopardy_MockResponseGenerator(false));    
            body = '{ "id" : "b45d456a-3bd4-4f73-92b5-547b603bcd07", "requestEventType" : "UPDATE", "subType" : "UPDATE", "status" : "UNUSED", "version" : "1.0.0", "sourceSystem" : { "systemId" : "AAAD3Test", "systemOrganization" : { "name" : "AAA", "code" : "014" } }, "targetSystem" : { "systemId" : "SLTest", "systemOrganization" : { "name" : "Salesforce", "code" : "014" } }, "createDate" : 1539736591270, "calls" : [ { "callKey" : "014-20180915-30000", "callDate" : "2018-09-15", "callId" : 30000, "version" : "1", "channel" : { "channelType" : "CALL_CENTER", "org" : { "name" : "HEATHROW", "code" : "HEA" }, "contact" : { "userId" : "JDC1234", "contactType" : "AGENT" }, "location" : { "latitude" : 28.769527, "longitude" : -81.362267, "address" : { "addressType" : "PHYSICAL", "full" : "1000 AAA DR, LAKE MARY, FL 32725", "streetNumber" : "1000", "streetDirection" : "EAST", "streetName" : "AAA DR", "crossStreet" : "INTERNATIONAL PKWY", "city" : "LAKE MARY", "county" : "SEMINOLE", "state" : "FL", "postalCode" : "32746", "country" : "UNITED STATES" } } }, "customer" : { "memberships" : [ { "membershipType" : "VIP", "sponsor" : "LINCOLN", "program" : "BLACK LABEL", "authorizationCode" : "1234534523", "authorizationLevel" : "123", "isLocalClub" : true, "org" : { "name" : "Auto Club Group", "code" : "014" }, "id" : "1234567890123456", "originalMemberId" : "1234567890123456", "expirationDate" : "2018-10-01", "memberLevel" : "PREMIERE", "memberBirthday" : "1978-09-15", "memberSince" : "1994", "memberStatus" : "ACTIVE", "entitlements" : [ { "serviceChargeIndicator" : false } ] } ], "contact" : { "contactType" : "CUSTOMER", "title" : "MR", "firstName" : "STEVE", "lastName" : "JONES", "phones" : [ { "phoneType" : "CELLULAR", "phoneNumber" : "1234567890", "phoneExtension" : "456", "preferred" : true, "smsOptIn" : true } ], "emails" : [ { "emailType" : "PERSONAL", "address" : "someuser@foobar.com" } ] }, "languagePreference" : "ENGLISH" }, "vehicle" : { "vehicleType" : "PS", "year" : 2012, "make" : "HONDA", "model" : "ACCORD", "trim" : "RX", "color" : "BLUE", "driveType" : "FW", "vin" : "432143124124E234", "tag" : "N12ABC", "state" : "FL", "odometer" : 78310, "fuelType" : "GAS", "rvInfo" : { "rvClass" : "A", "engineLocation" : "REAR", "gooseNeck" : false, "height" : 15.5, "length" : 24.2, "weight" : 1055, "towing" : false, "towingType" : "NOT TOWING" }, "trailerInfo" : { "axles" : 2, "condition" : "GOOD", "gooseNeck" : true, "hitchSize" : 3.5, "hitchType" : "BALL", "length" : 35.6, "loaded" : "????", "loadType" : "WATER", "loadWeight" : "1000", "plugType" : "7 PIN", "trailerType" : "5TH WHEEL" }, "specialEquipmentNeeds" : "NEED A BIG JACK" }, "service" : { "callType" : "MEMBER", "timezoneId" : "America/New_York", "timezoneOffset" : "UTC-07:00", "status" : { "status" : "SP", "modifiedDate" : "2018-09-15T10:05:21Z[UTC]", "eta" : "2018-09-15T10:05:41Z[UTC]", "pta" : "2018-09-15T10:05:51Z[UTC]", "waitTime" : 30 }, "appointmentTime" : "2018-09-15T10:05:51Z[UTC]", "facility" : { "foiType" : "ERS", "location" : { }, "id" : "9193", "name" : "BOBS TOWING ORLANDO SOUTH" }, "truck" : { "id" : "B1", "driver" : { "id" : "123", "contact" : { "contactType" : "DRIVER", "lastName" : "Truckdriver" } } }, "troubleCodes" : [ { "troubleCodeType" : "PACESETTER", "code" : "T680", "description" : "Engine Stalled While Driving" }, { "troubleCodeType" : "PACESETTER2", "code" : "T505", "description" : "L505 Parking Brake Wont Release" }, { "troubleCodeType" : "PROBLEM", "code" : "T6", "description" : "ENGINE STALLED" }, { "troubleCodeType" : "PROBLEM2", "code" : "T9", "description" : "PARKING BRAKE" } ], "serviceLocations" : [ { "serviceLocationType" : "BREAKDOWN", "foi" : { "foiType" : "ADDRESS", "location" : { "latitude" : 28.53349, "longitude" : -81.37751, "address" : { "addressType" : "PHYSICAL", "full" : "700 MAIN LANE, ORLANDO FL, 32801", "streetNumber" : "700", "streetDirection" : "SW", "streetName" : "MAIN LANE", "crossStreet" : "LUCERNE CIRCLE SW", "crossStreet2" : "HIGHWAY TO SOMEWHERE", "city" : "ORLANDO", "county" : "MONROE", "state" : "FL", "postalCode" : "32801", "country" : "UNITED STATES" }, "landmark" : "BOBS DINER", "highway" : "I-4", "mileMarker" : "47", "grid" : "B23", "zone" : "A1", "locationCode" : "BR" } }, "mileageCalculated" : 25, "driverDirections" : "GATECODE IS 12345" }, { "serviceLocationType" : "TOW_DESTINATION", "foi" : { "foiType" : "ADDRESS", "location" : { "latitude" : 26.98492, "longitude" : -82.10246, "address" : { "addressType" : "PHYSICAL", "full" : "3156 TAMIAMI TR, PORT CHARLOTTE, FL 33952", "streetNumber" : "3156", "streetName" : "TAMIAMI TR", "crossStreet" : "OCEAN BOULEVARD", "city" : "PORT CHARLOTTE", "county" : "PINELLAS", "state" : "FL", "postalCode" : "33952", "country" : "UNITED STATES" }, "landmark" : "AAR DON GASGARTHS CHARLOTTE CO FORD" }, "name" : "AAA DON GASGARTH CHARLOTTE CO FORD", "contacts" : [ { "contactType" : "TOWDEST", "firstName" : "BOB", "lastName" : "SHMOE", "phones" : [ { "phoneType" : "BUSINESS", "phoneNumber" : "8889996666", "preferred" : true } ] } ] }, "mileageCalculated" : 18, "dropBoxInfo" : "FACILITY DROPBOX IS LOCATED IN FRONT BY DOOR" } ], "collision" : false, "redFlag" : false, "priorityCode" : "P1", "legacyPriorityCode" : "P1", "numberOfPassengers" : 2, "needsFlatbed" : false, "flatbedRequested" : true, "policies" : [ { "code" : "POL1", "description" : "Service Policy1" } ], "providedServices" : [ { "providedServiceType" : "EXTRA CHARGE", "service" : "LONG TOW", "unit" : "MILES", "quantity" : 10, "charge" : { "chargeType" : "SERVICE_PROVIDED", "amount" : "5.00" } }, { "providedServiceType" : "", "service" : "GAS DELIVERY", "unit" : "GALLONS", "quantity" : 5 } ], "charges" : [ { "chargeType" : "GAS", "amount" : "10.00" } ] }, "payment" : { "required" : true, "paymentType" : "CREDIT", "codes" : "SOME PAYMENT CODES GO HERE" }, "comments" : [ { "system" : { "systemId" : "AAAD3Test", "systemOrganization" : { "name" : "AAA", "code" : "014" } }, "contact" : { "userId" : "ab5678", "contactType" : "AGENT" }, "commentDate" : "2018-09-15T10:05:20Z[UTC]", "commentType" : "CALL", "visibility" : "EXTERNAL", "text" : "THIS IS A COMMENT ABOUT THIS CALL VISIBLE TO ALL USERS" } ] } ] }';
            
            System.Test.setMock(HttpCalloutMock.class, new FSL_ToD3UpdateCalloutMockImpl(200, 'OK', body, responseHeaders));
            FSL_ToD3Update.makePostCallout( jsonReq, '45637', new Set<Id>{workOrderList[0].Id, workOrderList[0].id});            
            System.Test.StopTest();     
        }
    }

    @isTest
    static void makePostCalloutNotFutureTest(){
        
        string jsonReq = '{"id":"7051b8d9-1076-4bc9-82c2-0d50a30cc7d6","requestEventType":"UPDATE","subType":"UPDATE","status":"UNUSED","version":"1.0.0","sourceSystem":{"systemId":"AAAD3Test","systemOrganziation":{"name":"AAA","code":"014"}},"targetSystem":{"systemId":"SLTest","systemOrganziation":{"name":"Salesforce","code":"014"}},"createDate":1538566964227,"calls":[{"callKey":"014-20180915-30000","callDate":"2018-09-15","callId":30000,"version":"1","channel":{"channelType":"CALL_CENTER","org":{"name":"HEATHROW","code":"HEA"},"contact":{"userId":"JDC1234","contactType":"AGENT"},"location":{"latitude":28.769527,"longitude":-81.362267,"address":{"addressType":"PHYSICAL","full":"1000 AAA DR, LAKE MARY, FL 32725","streetNumber":"1000","streetDirection":"EAST","streetName":"AAA DR","crossStreet":"INTERNATIONAL PKWY","city":"LAKE MARY","county":"SEMINOLE","state":"FL","postalCode":"32746","country":"UNITED STATES"}}},"customer":{"memberships":[{"membershipType":"VIP","sponsor":"LINCOLN","program":"BLACK LABEL","authorizationCode":"1234534523","authorizationLevel":"123","isLocalClub":true,"org":{"name":"Auto Club Group","code":"014"},"id":"1234567890123456","expirationDate":"2018-10-01","memberLevel":"PREMIERE","memberBirthday":"1978-09-15","memberSince":"1994","memberStatus":"ACTIVE","entitlements":[{"serviceChargeIndicator":false}]}],"contact":{"contactType":"CUSTOMER","title":"MR","firstName":"STEVE","lastName":"JONES","phones":[{"phoneType":"CELLULAR","phoneNumber":"1234567890","phoneExtension":"456","preferred":true,"smsOptIn":true}],"emails":[{"emailType":"PERSONAL","address":"someuser@foobar.com"}]},"languagePreference":"ENGLISH"},"vehicle":{"vehicleType":"PS","year":2012,"make":"HONDA","model":"ACCORD","trim":"RX","color":"BLUE","driveType":"FW","vin":"432143124124E234","tag":"N12ABC","state":"FL","odometer":78310,"fuelType":"GAS","rvInfo":{"rvClass":"A","engineLocation":"REAR","gooseNeck":false,"height":15.5,"length":24.2,"weight":1055,"towing":false,"towingType":"NOT TOWING"},"trailerInfo":{"axles":2,"condition":"GOOD","gooseNeck":true,"hitchSize":3.5,"hitchType":"BALL","length":35.6,"loaded":"????","loadType":"WATER","loadWeight":"1000","plugType":"7 PIN","trailerType":"5TH WHEEL"},"specialEquipmentNeeds":"NEED A BIG"},"service":{"callType":"MEMBER","timezoneId":"America/New_York","timezoneOffset":"UTC-07:00","status":{"status":"SP","modifiedDate":"2018-09-15T10:05:21Z[UTC]","eta":"2018-09-15T10:05:41Z[UTC]","pta":"2018-09-15T10:05:51Z[UTC]","waitTime":30},"appointmentTime":"2018-09-15T10:05:51Z[UTC]","facility":{"foiType":"ERS","location":{},"id":"9193","name":"BOBS TOWING ORLANDO SOUTH"},"troubleCodes":[{"troubleCodeType":"PACESETTER","code":"T680","description":"Engine Stalled While Driving"},{"troubleCodeType":"PACESETTER2","code":"T505","description":"L505 Parking Brake Wont Release"},{"troubleCodeType":"PROBLEM","code":"T6","description":"ENGINE STALLED"},{"troubleCodeType":"PROBLEM2","code":"T9","description":"PARKING BRAKE"}],"serviceLocations":[{"serviceLocationType":"BREAKDOWN","foi":{"foiType":"ADDRESS","location":{"latitude":28.53349,"longitude":-81.37751,"address":{"addressType":"PHYSICAL","full":"700 MAIN LANE, ORLANDO FL, 32801","streetNumber":"700","streetDirection":"SW","streetName":"MAIN LANE","crossStreet":"LUCERNE CIRCLE SW","crossStreet2":"HIGHWAY TO SOMEWHERE","city":"ORLANDO","county":"MONROE","state":"FL","postalCode":"32801","country":"UNITED STATES"},"highway":"I-4","mileMarker":"47","grid":"B23","zone":"A1","locationCode":"BR"}},"mileageCalculated":25,"driverDirections":"GATECODE IS 12345"},{"serviceLocationType":"TOW_DESTINATION","foi":{"foiType":"ADDRESS","location":{"latitude":26.98492,"longitude":-82.10246,"address":{"addressType":"PHYSICAL","full":"3156 TAMIAMI TR, PORT CHARLOTTE, FL 33952","streetNumber":"3156","streetName":"TAMIAMI TR","crossStreet":"OCEAN BOULEVARD","city":"PORT CHARLOTTE","county":"PINELLAS","state":"FL","postalCode":"33952","country":"UNITED STATES"},"landmark":"AAR DON GASGARTHS CHARLOTTE CO FORD"},"name":"AAA DON GASGARTH CHARLOTTE CO FORD","contacts":[{"contactType":"TOWDEST","firstName":"BOB","lastName":"SHMOE","phones":[{"phoneType":"BUSINESS","phoneNumber":"8889996666","preferred":true}]}]},"mileageCalculated":18,"dropBoxInfo":"FACILITY DROPBOX IS LOCATED IN FRONT BY DOOR"}],"collision":false,"redFlag":false,"priorityCode":"P1","numberOfPassengers":2,"needsFlatbed":false,"flatbedRequested":true,"policies":[{"code":"POL1","description":"Service Policy1"}]},"payment":{"required":true,"paymentType":"CREDIT","codes":"SOME PAYMENT CODES GO HERE"},"comments":[{"system":{"systemId":"AAAD3Test","systemOrganziation":{"name":"AAA","code":"014"}},"contact":{"userId":"ab5678","contactType":"AGENT"},"commentDate":"2018-09-15T10:05:20Z[UTC]","commentType":"CALL","visibility":"EXTERNAL","text":"THIS IS A COMMENT ABOUT THIS CALL VISIBLE TO ALL USERS"}]}]}';
    
        FSL_Service_Endpoints__c endpoint = new FSL_Service_Endpoints__c(); //// Added this custom setting as required for makePostCallout method.
        endpoint.Endpoint_URL__c ='org_id=81511&foreign_id=';
        endpoint.client_id__c = '1qe4s3snv71lu6j301urnvblgv';
        endpoint.Client_Secret__c = 'ku4ufh1ig5corgjjbbk1chmbkknk6ke3e9sqj2im2o0p9qlkhr9';
        endpoint.Client_Cert_Name__c = 'ace_fsl_uat';
        endpoint.Timeout__c = 20000;
        endpoint.Named_Credential__c = 'OAuth';
        endpoint.Name='OAuth';
        insert endpoint;
        
        FSL_DataFactory.createWOIntakeCall('FSL_LightCall');
        List<WorkOrder> workOrderList = [Select Id, (select id, SchedStartTime, SchedEndTime, actualstarttime, PTA__c from ServiceAppointments) from WorkOrder];
        ServiceResource serviceResource = [select id, Primary_Service_Territory__c, Primary_Service_Territory__r.OperatingHoursId from serviceresource where ResourceType='T' limit 1];
        list<ServiceAppointment> SAList = new list<ServiceAppointment>();
        list<AssignedResource> ARList = new list<AssignedResource>();
        for(workOrder wo : workOrderList){
            wo.ServiceAppointments[0].SchedStartTime = System.now();
            wo.ServiceAppointments[0].SchedEndTime = System.now()+1800;
            wo.ServiceAppointments[0].actualstarttime = System.now();
            wo.ServiceAppointments[0].PTA__c = System.now();
            SAList.add(wo.ServiceAppointments[0]); 
            
            AssignedResource assignedResource = FSL_DataFactory.createAssignedResource(wo.ServiceAppointments[0].Id, serviceResource.Id);
            ARList.add(assignedResource);
        }
        
        update SAList;
        //insert ARList;
        System.Test.StartTest(); 
            Test.setMock(HttpCalloutMock.class, new FSL_WOJeopardy_MockResponseGenerator(false));    
            body = '{ "id" : "b45d456a-3bd4-4f73-92b5-547b603bcd07", "requestEventType" : "UPDATE", "subType" : "UPDATE", "status" : "UNUSED", "version" : "1.0.0", "sourceSystem" : { "systemId" : "AAAD3Test", "systemOrganization" : { "name" : "AAA", "code" : "014" } }, "targetSystem" : { "systemId" : "SLTest", "systemOrganization" : { "name" : "Salesforce", "code" : "014" } }, "createDate" : 1539736591270, "calls" : [ { "callKey" : "014-20180915-30000", "callDate" : "2018-09-15", "callId" : 30000, "version" : "1", "channel" : { "channelType" : "CALL_CENTER", "org" : { "name" : "HEATHROW", "code" : "HEA" }, "contact" : { "userId" : "JDC1234", "contactType" : "AGENT" }, "location" : { "latitude" : 28.769527, "longitude" : -81.362267, "address" : { "addressType" : "PHYSICAL", "full" : "1000 AAA DR, LAKE MARY, FL 32725", "streetNumber" : "1000", "streetDirection" : "EAST", "streetName" : "AAA DR", "crossStreet" : "INTERNATIONAL PKWY", "city" : "LAKE MARY", "county" : "SEMINOLE", "state" : "FL", "postalCode" : "32746", "country" : "UNITED STATES" } } }, "customer" : { "memberships" : [ { "membershipType" : "VIP", "sponsor" : "LINCOLN", "program" : "BLACK LABEL", "authorizationCode" : "1234534523", "authorizationLevel" : "123", "isLocalClub" : true, "org" : { "name" : "Auto Club Group", "code" : "014" }, "id" : "1234567890123456", "originalMemberId" : "1234567890123456", "expirationDate" : "2018-10-01", "memberLevel" : "PREMIERE", "memberBirthday" : "1978-09-15", "memberSince" : "1994", "memberStatus" : "ACTIVE", "entitlements" : [ { "serviceChargeIndicator" : false } ] } ], "contact" : { "contactType" : "CUSTOMER", "title" : "MR", "firstName" : "STEVE", "lastName" : "JONES", "phones" : [ { "phoneType" : "CELLULAR", "phoneNumber" : "1234567890", "phoneExtension" : "456", "preferred" : true, "smsOptIn" : true } ], "emails" : [ { "emailType" : "PERSONAL", "address" : "someuser@foobar.com" } ] }, "languagePreference" : "ENGLISH" }, "vehicle" : { "vehicleType" : "PS", "year" : 2012, "make" : "HONDA", "model" : "ACCORD", "trim" : "RX", "color" : "BLUE", "driveType" : "FW", "vin" : "432143124124E234", "tag" : "N12ABC", "state" : "FL", "odometer" : 78310, "fuelType" : "GAS", "rvInfo" : { "rvClass" : "A", "engineLocation" : "REAR", "gooseNeck" : false, "height" : 15.5, "length" : 24.2, "weight" : 1055, "towing" : false, "towingType" : "NOT TOWING" }, "trailerInfo" : { "axles" : 2, "condition" : "GOOD", "gooseNeck" : true, "hitchSize" : 3.5, "hitchType" : "BALL", "length" : 35.6, "loaded" : "????", "loadType" : "WATER", "loadWeight" : "1000", "plugType" : "7 PIN", "trailerType" : "5TH WHEEL" }, "specialEquipmentNeeds" : "NEED A BIG JACK" }, "service" : { "callType" : "MEMBER", "timezoneId" : "America/New_York", "timezoneOffset" : "UTC-07:00", "status" : { "status" : "SP", "modifiedDate" : "2018-09-15T10:05:21Z[UTC]", "eta" : "2018-09-15T10:05:41Z[UTC]", "pta" : "2018-09-15T10:05:51Z[UTC]", "waitTime" : 30 }, "appointmentTime" : "2018-09-15T10:05:51Z[UTC]", "facility" : { "foiType" : "ERS", "location" : { }, "id" : "9193", "name" : "BOBS TOWING ORLANDO SOUTH" }, "truck" : { "id" : "B1", "driver" : { "id" : "123", "contact" : { "contactType" : "DRIVER", "lastName" : "Truckdriver" } } }, "troubleCodes" : [ { "troubleCodeType" : "PACESETTER", "code" : "T680", "description" : "Engine Stalled While Driving" }, { "troubleCodeType" : "PACESETTER2", "code" : "T505", "description" : "L505 Parking Brake Wont Release" }, { "troubleCodeType" : "PROBLEM", "code" : "T6", "description" : "ENGINE STALLED" }, { "troubleCodeType" : "PROBLEM2", "code" : "T9", "description" : "PARKING BRAKE" } ], "serviceLocations" : [ { "serviceLocationType" : "BREAKDOWN", "foi" : { "foiType" : "ADDRESS", "location" : { "latitude" : 28.53349, "longitude" : -81.37751, "address" : { "addressType" : "PHYSICAL", "full" : "700 MAIN LANE, ORLANDO FL, 32801", "streetNumber" : "700", "streetDirection" : "SW", "streetName" : "MAIN LANE", "crossStreet" : "LUCERNE CIRCLE SW", "crossStreet2" : "HIGHWAY TO SOMEWHERE", "city" : "ORLANDO", "county" : "MONROE", "state" : "FL", "postalCode" : "32801", "country" : "UNITED STATES" }, "landmark" : "BOBS DINER", "highway" : "I-4", "mileMarker" : "47", "grid" : "B23", "zone" : "A1", "locationCode" : "BR" } }, "mileageCalculated" : 25, "driverDirections" : "GATECODE IS 12345" }, { "serviceLocationType" : "TOW_DESTINATION", "foi" : { "foiType" : "ADDRESS", "location" : { "latitude" : 26.98492, "longitude" : -82.10246, "address" : { "addressType" : "PHYSICAL", "full" : "3156 TAMIAMI TR, PORT CHARLOTTE, FL 33952", "streetNumber" : "3156", "streetName" : "TAMIAMI TR", "crossStreet" : "OCEAN BOULEVARD", "city" : "PORT CHARLOTTE", "county" : "PINELLAS", "state" : "FL", "postalCode" : "33952", "country" : "UNITED STATES" }, "landmark" : "AAR DON GASGARTHS CHARLOTTE CO FORD" }, "name" : "AAA DON GASGARTH CHARLOTTE CO FORD", "contacts" : [ { "contactType" : "TOWDEST", "firstName" : "BOB", "lastName" : "SHMOE", "phones" : [ { "phoneType" : "BUSINESS", "phoneNumber" : "8889996666", "preferred" : true } ] } ] }, "mileageCalculated" : 18, "dropBoxInfo" : "FACILITY DROPBOX IS LOCATED IN FRONT BY DOOR" } ], "collision" : false, "redFlag" : false, "priorityCode" : "P1", "legacyPriorityCode" : "P1", "numberOfPassengers" : 2, "needsFlatbed" : false, "flatbedRequested" : true, "policies" : [ { "code" : "POL1", "description" : "Service Policy1" } ], "providedServices" : [ { "providedServiceType" : "EXTRA CHARGE", "service" : "LONG TOW", "unit" : "MILES", "quantity" : 10, "charge" : { "chargeType" : "SERVICE_PROVIDED", "amount" : "5.00" } }, { "providedServiceType" : "", "service" : "GAS DELIVERY", "unit" : "GALLONS", "quantity" : 5 } ], "charges" : [ { "chargeType" : "GAS", "amount" : "10.00" } ] }, "payment" : { "required" : true, "paymentType" : "CREDIT", "codes" : "SOME PAYMENT CODES GO HERE" }, "comments" : [ { "system" : { "systemId" : "AAAD3Test", "systemOrganization" : { "name" : "AAA", "code" : "014" } }, "contact" : { "userId" : "ab5678", "contactType" : "AGENT" }, "commentDate" : "2018-09-15T10:05:20Z[UTC]", "commentType" : "CALL", "visibility" : "EXTERNAL", "text" : "THIS IS A COMMENT ABOUT THIS CALL VISIBLE TO ALL USERS" } ] } ] }';
            System.Test.setMock(HttpCalloutMock.class, new FSL_ToD3UpdateCalloutMockImpl(200, 'OK', body, responseHeaders));
            FSL_ToD3Update.makePostCalloutNotFuture( jsonReq, '45637', new Set<Id>{workOrderList[0].Id, workOrderList[0].id});                    
        System.Test.StopTest();
    }
    
    static testMethod void makePostCalloutBlankResponseTest(){
        string jsonReq = '{"id":"7051b8d9-1076-4bc9-82c2-0d50a30cc7d6","requestEventType":"UPDATE","subType":"UPDATE","status":"UNUSED","version":"1.0.0","sourceSystem":{"systemId":"AAAD3Test","systemOrganziation":{"name":"AAA","code":"014"}},"targetSystem":{"systemId":"SLTest","systemOrganziation":{"name":"Salesforce","code":"014"}},"createDate":1538566964227,"calls":[{"callKey":"014-20180915-30000","callDate":"2018-09-15","callId":30000,"version":"1","channel":{"channelType":"CALL_CENTER","org":{"name":"HEATHROW","code":"HEA"},"contact":{"userId":"JDC1234","contactType":"AGENT"},"location":{"latitude":28.769527,"longitude":-81.362267,"address":{"addressType":"PHYSICAL","full":"1000 AAA DR, LAKE MARY, FL 32725","streetNumber":"1000","streetDirection":"EAST","streetName":"AAA DR","crossStreet":"INTERNATIONAL PKWY","city":"LAKE MARY","county":"SEMINOLE","state":"FL","postalCode":"32746","country":"UNITED STATES"}}},"customer":{"memberships":[{"membershipType":"VIP","sponsor":"LINCOLN","program":"BLACK LABEL","authorizationCode":"1234534523","authorizationLevel":"123","isLocalClub":true,"org":{"name":"Auto Club Group","code":"014"},"id":"1234567890123456","expirationDate":"2018-10-01","memberLevel":"PREMIERE","memberBirthday":"1978-09-15","memberSince":"1994","memberStatus":"ACTIVE","entitlements":[{"serviceChargeIndicator":false}]}],"contact":{"contactType":"CUSTOMER","title":"MR","firstName":"STEVE","lastName":"JONES","phones":[{"phoneType":"CELLULAR","phoneNumber":"1234567890","phoneExtension":"456","preferred":true,"smsOptIn":true}],"emails":[{"emailType":"PERSONAL","address":"someuser@foobar.com"}]},"languagePreference":"ENGLISH"},"vehicle":{"vehicleType":"PS","year":2012,"make":"HONDA","model":"ACCORD","trim":"RX","color":"BLUE","driveType":"FW","vin":"432143124124E234","tag":"N12ABC","state":"FL","odometer":78310,"fuelType":"GAS","rvInfo":{"rvClass":"A","engineLocation":"REAR","gooseNeck":false,"height":15.5,"length":24.2,"weight":1055,"towing":false,"towingType":"NOT TOWING"},"trailerInfo":{"axles":2,"condition":"GOOD","gooseNeck":true,"hitchSize":3.5,"hitchType":"BALL","length":35.6,"loaded":"????","loadType":"WATER","loadWeight":"1000","plugType":"7 PIN","trailerType":"5TH WHEEL"},"specialEquipmentNeeds":"NEED A BIG"},"service":{"callType":"MEMBER","timezoneId":"America/New_York","timezoneOffset":"UTC-07:00","status":{"status":"SP","modifiedDate":"2018-09-15T10:05:21Z[UTC]","eta":"2018-09-15T10:05:41Z[UTC]","pta":"2018-09-15T10:05:51Z[UTC]","waitTime":30},"appointmentTime":"2018-09-15T10:05:51Z[UTC]","facility":{"foiType":"ERS","location":{},"id":"9193","name":"BOBS TOWING ORLANDO SOUTH"},"troubleCodes":[{"troubleCodeType":"PACESETTER","code":"T680","description":"Engine Stalled While Driving"},{"troubleCodeType":"PACESETTER2","code":"T505","description":"L505 Parking Brake Wont Release"},{"troubleCodeType":"PROBLEM","code":"T6","description":"ENGINE STALLED"},{"troubleCodeType":"PROBLEM2","code":"T9","description":"PARKING BRAKE"}],"serviceLocations":[{"serviceLocationType":"BREAKDOWN","foi":{"foiType":"ADDRESS","location":{"latitude":28.53349,"longitude":-81.37751,"address":{"addressType":"PHYSICAL","full":"700 MAIN LANE, ORLANDO FL, 32801","streetNumber":"700","streetDirection":"SW","streetName":"MAIN LANE","crossStreet":"LUCERNE CIRCLE SW","crossStreet2":"HIGHWAY TO SOMEWHERE","city":"ORLANDO","county":"MONROE","state":"FL","postalCode":"32801","country":"UNITED STATES"},"highway":"I-4","mileMarker":"47","grid":"B23","zone":"A1","locationCode":"BR"}},"mileageCalculated":25,"driverDirections":"GATECODE IS 12345"},{"serviceLocationType":"TOW_DESTINATION","foi":{"foiType":"ADDRESS","location":{"latitude":26.98492,"longitude":-82.10246,"address":{"addressType":"PHYSICAL","full":"3156 TAMIAMI TR, PORT CHARLOTTE, FL 33952","streetNumber":"3156","streetName":"TAMIAMI TR","crossStreet":"OCEAN BOULEVARD","city":"PORT CHARLOTTE","county":"PINELLAS","state":"FL","postalCode":"33952","country":"UNITED STATES"},"landmark":"AAR DON GASGARTHS CHARLOTTE CO FORD"},"name":"AAA DON GASGARTH CHARLOTTE CO FORD","contacts":[{"contactType":"TOWDEST","firstName":"BOB","lastName":"SHMOE","phones":[{"phoneType":"BUSINESS","phoneNumber":"8889996666","preferred":true}]}]},"mileageCalculated":18,"dropBoxInfo":"FACILITY DROPBOX IS LOCATED IN FRONT BY DOOR"}],"collision":false,"redFlag":false,"priorityCode":"P1","numberOfPassengers":2,"needsFlatbed":false,"flatbedRequested":true,"policies":[{"code":"POL1","description":"Service Policy1"}]},"payment":{"required":true,"paymentType":"CREDIT","codes":"SOME PAYMENT CODES GO HERE"},"comments":[{"system":{"systemId":"AAAD3Test","systemOrganziation":{"name":"AAA","code":"014"}},"contact":{"userId":"ab5678","contactType":"AGENT"},"commentDate":"2018-09-15T10:05:20Z[UTC]","commentType":"CALL","visibility":"EXTERNAL","text":"THIS IS A COMMENT ABOUT THIS CALL VISIBLE TO ALL USERS"}]}]}';
        List<User> users = [SELECT Id FROM user WHERE alias = 'C_Admin'];
        PermissionSet pset = [SELECT Id FROM PermissionSet WHERE Name = 'Skip_Sharing_Logic'][0];

        insert new PermissionSetAssignment(AssigneeId=users[0].Id, PermissionSetId=pset.Id); 
        System.runAs( users[0] ) {
            System.Test.StartTest(); 
            
            FSL_Service_Endpoints__c endpoint = new FSL_Service_Endpoints__c(); // Added this custom setting as required for makePostCallout method.
            endpoint.Endpoint_URL__c ='org_id=81511&foreign_id=';
            endpoint.client_id__c = '1qe4s3snv71lu6j301urnvblgv';
            endpoint.Client_Secret__c = 'ku4ufh1ig5corgjjbbk1chmbkknk6ke3e9sqj2im2o0p9qlkhr9';
            endpoint.Client_Cert_Name__c = 'ace_fsl_uat';
            endpoint.Timeout__c = 20000;
            endpoint.Named_Credential__c = 'OAuth';
            endpoint.Name='OAuth';
            insert endpoint;
            
            FSL_DataFactory.createWOIntakeCall('FSL_LightCall');
            List<WorkOrder> workOrderList = [Select Id, (select id, SchedStartTime, SchedEndTime, actualstarttime, PTA__c from ServiceAppointments) from WorkOrder];
            ServiceResource serviceResource = [select id, Primary_Service_Territory__c, Primary_Service_Territory__r.OperatingHoursId from serviceresource where ResourceType='T' limit 1];
            list<ServiceAppointment> SAList = new list<ServiceAppointment>();
            list<AssignedResource> ARList = new list<AssignedResource>();
            for(workOrder wo : workOrderList){
                wo.ServiceAppointments[0].SchedStartTime = System.now();
                wo.ServiceAppointments[0].SchedEndTime = System.now()+1800;
                wo.ServiceAppointments[0].actualstarttime = System.now();
                wo.ServiceAppointments[0].PTA__c = System.now();
                SAList.add(wo.ServiceAppointments[0]); 
                
                AssignedResource assignedResource = FSL_DataFactory.createAssignedResource(wo.ServiceAppointments[0].Id, serviceResource.Id);
                ARList.add(assignedResource);
            }
            
            update SAList;
            insert ARList;        
            Test.setMock(HttpCalloutMock.class, new FSL_WOJeopardy_MockResponseGenerator(false));   
            body = '';                
            System.Test.setMock(HttpCalloutMock.class, new FSL_ToD3UpdateCalloutMockImpl(200, 'OK', body, responseHeaders));
            FSL_ToD3Update.makePostCallout( jsonReq, '45637', new Set<Id>{workOrderList[0].Id, workOrderList[0].id});            
            System.Test.StopTest();     
        }
    }
    
    static testMethod void makePostCalloutNotSuccessTest(){
        string jsonReq = '{"id":"7051b8d9-1076-4bc9-82c2-0d50a30cc7d6","requestEventType":"UPDATE","subType":"UPDATE","status":"UNUSED","version":"1.0.0","sourceSystem":{"systemId":"AAAD3Test","systemOrganziation":{"name":"AAA","code":"014"}},"targetSystem":{"systemId":"SLTest","systemOrganziation":{"name":"Salesforce","code":"014"}},"createDate":1538566964227,"calls":[{"callKey":"014-20180915-30000","callDate":"2018-09-15","callId":30000,"version":"1","channel":{"channelType":"CALL_CENTER","org":{"name":"HEATHROW","code":"HEA"},"contact":{"userId":"JDC1234","contactType":"AGENT"},"location":{"latitude":28.769527,"longitude":-81.362267,"address":{"addressType":"PHYSICAL","full":"1000 AAA DR, LAKE MARY, FL 32725","streetNumber":"1000","streetDirection":"EAST","streetName":"AAA DR","crossStreet":"INTERNATIONAL PKWY","city":"LAKE MARY","county":"SEMINOLE","state":"FL","postalCode":"32746","country":"UNITED STATES"}}},"customer":{"memberships":[{"membershipType":"VIP","sponsor":"LINCOLN","program":"BLACK LABEL","authorizationCode":"1234534523","authorizationLevel":"123","isLocalClub":true,"org":{"name":"Auto Club Group","code":"014"},"id":"1234567890123456","expirationDate":"2018-10-01","memberLevel":"PREMIERE","memberBirthday":"1978-09-15","memberSince":"1994","memberStatus":"ACTIVE","entitlements":[{"serviceChargeIndicator":false}]}],"contact":{"contactType":"CUSTOMER","title":"MR","firstName":"STEVE","lastName":"JONES","phones":[{"phoneType":"CELLULAR","phoneNumber":"1234567890","phoneExtension":"456","preferred":true,"smsOptIn":true}],"emails":[{"emailType":"PERSONAL","address":"someuser@foobar.com"}]},"languagePreference":"ENGLISH"},"vehicle":{"vehicleType":"PS","year":2012,"make":"HONDA","model":"ACCORD","trim":"RX","color":"BLUE","driveType":"FW","vin":"432143124124E234","tag":"N12ABC","state":"FL","odometer":78310,"fuelType":"GAS","rvInfo":{"rvClass":"A","engineLocation":"REAR","gooseNeck":false,"height":15.5,"length":24.2,"weight":1055,"towing":false,"towingType":"NOT TOWING"},"trailerInfo":{"axles":2,"condition":"GOOD","gooseNeck":true,"hitchSize":3.5,"hitchType":"BALL","length":35.6,"loaded":"????","loadType":"WATER","loadWeight":"1000","plugType":"7 PIN","trailerType":"5TH WHEEL"},"specialEquipmentNeeds":"NEED A BIG"},"service":{"callType":"MEMBER","timezoneId":"America/New_York","timezoneOffset":"UTC-07:00","status":{"status":"SP","modifiedDate":"2018-09-15T10:05:21Z[UTC]","eta":"2018-09-15T10:05:41Z[UTC]","pta":"2018-09-15T10:05:51Z[UTC]","waitTime":30},"appointmentTime":"2018-09-15T10:05:51Z[UTC]","facility":{"foiType":"ERS","location":{},"id":"9193","name":"BOBS TOWING ORLANDO SOUTH"},"troubleCodes":[{"troubleCodeType":"PACESETTER","code":"T680","description":"Engine Stalled While Driving"},{"troubleCodeType":"PACESETTER2","code":"T505","description":"L505 Parking Brake Wont Release"},{"troubleCodeType":"PROBLEM","code":"T6","description":"ENGINE STALLED"},{"troubleCodeType":"PROBLEM2","code":"T9","description":"PARKING BRAKE"}],"serviceLocations":[{"serviceLocationType":"BREAKDOWN","foi":{"foiType":"ADDRESS","location":{"latitude":28.53349,"longitude":-81.37751,"address":{"addressType":"PHYSICAL","full":"700 MAIN LANE, ORLANDO FL, 32801","streetNumber":"700","streetDirection":"SW","streetName":"MAIN LANE","crossStreet":"LUCERNE CIRCLE SW","crossStreet2":"HIGHWAY TO SOMEWHERE","city":"ORLANDO","county":"MONROE","state":"FL","postalCode":"32801","country":"UNITED STATES"},"highway":"I-4","mileMarker":"47","grid":"B23","zone":"A1","locationCode":"BR"}},"mileageCalculated":25,"driverDirections":"GATECODE IS 12345"},{"serviceLocationType":"TOW_DESTINATION","foi":{"foiType":"ADDRESS","location":{"latitude":26.98492,"longitude":-82.10246,"address":{"addressType":"PHYSICAL","full":"3156 TAMIAMI TR, PORT CHARLOTTE, FL 33952","streetNumber":"3156","streetName":"TAMIAMI TR","crossStreet":"OCEAN BOULEVARD","city":"PORT CHARLOTTE","county":"PINELLAS","state":"FL","postalCode":"33952","country":"UNITED STATES"},"landmark":"AAR DON GASGARTHS CHARLOTTE CO FORD"},"name":"AAA DON GASGARTH CHARLOTTE CO FORD","contacts":[{"contactType":"TOWDEST","firstName":"BOB","lastName":"SHMOE","phones":[{"phoneType":"BUSINESS","phoneNumber":"8889996666","preferred":true}]}]},"mileageCalculated":18,"dropBoxInfo":"FACILITY DROPBOX IS LOCATED IN FRONT BY DOOR"}],"collision":false,"redFlag":false,"priorityCode":"P1","numberOfPassengers":2,"needsFlatbed":false,"flatbedRequested":true,"policies":[{"code":"POL1","description":"Service Policy1"}]},"payment":{"required":true,"paymentType":"CREDIT","codes":"SOME PAYMENT CODES GO HERE"},"comments":[{"system":{"systemId":"AAAD3Test","systemOrganziation":{"name":"AAA","code":"014"}},"contact":{"userId":"ab5678","contactType":"AGENT"},"commentDate":"2018-09-15T10:05:20Z[UTC]","commentType":"CALL","visibility":"EXTERNAL","text":"THIS IS A COMMENT ABOUT THIS CALL VISIBLE TO ALL USERS"}]}]}';
        List<User> users = [SELECT Id FROM user WHERE alias = 'C_Admin'];
        PermissionSet pset = [SELECT Id FROM PermissionSet WHERE Name = 'Skip_Sharing_Logic'][0];

        insert new PermissionSetAssignment(AssigneeId=users[0].Id, PermissionSetId=pset.Id); 
        System.runAs( users[0] ) {
            System.Test.StartTest(); 
            FSL_Service_Endpoints__c endpoint = new FSL_Service_Endpoints__c(); // Added this custom setting as required for makePostCallout method.
            endpoint.Endpoint_URL__c = 'org_id=81511&foreign_id=';
            endpoint.client_id__c = '1qe4s3snv71lu6j301urnvblgv';
            endpoint.Client_Secret__c = 'ku4ufh1ig5corgjjbbk1chmbkknk6ke3e9sqj2im2o0p9qlkhr9';
            endpoint.Client_Cert_Name__c = 'ace_fsl_uat';
            endpoint.Timeout__c = 20000;
            endpoint.Named_Credential__c = 'OAuth';
            endpoint.Name='OAuth';
            insert endpoint;
            
            FSL_DataFactory.createWOIntakeCall('FSL_LightCall');
            List<WorkOrder> workOrderList = [Select Id, (select id, SchedStartTime, SchedEndTime, actualstarttime, PTA__c from ServiceAppointments) from WorkOrder];
            ServiceResource serviceResource = [select id, Primary_Service_Territory__c, Primary_Service_Territory__r.OperatingHoursId from serviceresource where ResourceType='T' limit 1];
            list<ServiceAppointment> SAList = new list<ServiceAppointment>();
            list<AssignedResource> ARList = new list<AssignedResource>();
            for(workOrder wo : workOrderList){
                wo.ServiceAppointments[0].SchedStartTime = System.now();
                wo.ServiceAppointments[0].SchedEndTime = System.now()+1800;
                wo.ServiceAppointments[0].actualstarttime = System.now();
                wo.ServiceAppointments[0].PTA__c = System.now();
                SAList.add(wo.ServiceAppointments[0]); 
                
                AssignedResource assignedResource = FSL_DataFactory.createAssignedResource(wo.ServiceAppointments[0].Id, serviceResource.Id);
                ARList.add(assignedResource);
            }
            
            update SAList;
            insert ARList;        
            Test.setMock(HttpCalloutMock.class, new FSL_WOJeopardy_MockResponseGenerator(false));  
            body = '{ "id" : "b45d456a-3bd4-4f73-92b5-547b603bcd07", "requestEventType" : "UPDATE", "subType" : "UPDATE", "status" : "UNUSED", "version" : "1.0.0", "sourceSystem" : { "systemId" : "AAAD3Test", "systemOrganization" : { "name" : "AAA", "code" : "014" } }, "targetSystem" : { "systemId" : "SLTest", "systemOrganization" : { "name" : "Salesforce", "code" : "014" } }, "createDate" : 1539736591270, "calls" : [ { "callKey" : "014-20180915-30000", "callDate" : "2018-09-15", "callId" : 30000, "version" : "1", "channel" : { "channelType" : "CALL_CENTER", "org" : { "name" : "HEATHROW", "code" : "HEA" }, "contact" : { "userId" : "JDC1234", "contactType" : "AGENT" }, "location" : { "latitude" : 28.769527, "longitude" : -81.362267, "address" : { "addressType" : "PHYSICAL", "full" : "1000 AAA DR, LAKE MARY, FL 32725", "streetNumber" : "1000", "streetDirection" : "EAST", "streetName" : "AAA DR", "crossStreet" : "INTERNATIONAL PKWY", "city" : "LAKE MARY", "county" : "SEMINOLE", "state" : "FL", "postalCode" : "32746", "country" : "UNITED STATES" } } }, "customer" : { "memberships" : [ { "membershipType" : "VIP", "sponsor" : "LINCOLN", "program" : "BLACK LABEL", "authorizationCode" : "1234534523", "authorizationLevel" : "123", "isLocalClub" : true, "org" : { "name" : "Auto Club Group", "code" : "014" }, "id" : "1234567890123456", "originalMemberId" : "1234567890123456", "expirationDate" : "2018-10-01", "memberLevel" : "PREMIERE", "memberBirthday" : "1978-09-15", "memberSince" : "1994", "memberStatus" : "ACTIVE", "entitlements" : [ { "serviceChargeIndicator" : false } ] } ], "contact" : { "contactType" : "CUSTOMER", "title" : "MR", "firstName" : "STEVE", "lastName" : "JONES", "phones" : [ { "phoneType" : "CELLULAR", "phoneNumber" : "1234567890", "phoneExtension" : "456", "preferred" : true, "smsOptIn" : true } ], "emails" : [ { "emailType" : "PERSONAL", "address" : "someuser@foobar.com" } ] }, "languagePreference" : "ENGLISH" }, "vehicle" : { "vehicleType" : "PS", "year" : 2012, "make" : "HONDA", "model" : "ACCORD", "trim" : "RX", "color" : "BLUE", "driveType" : "FW", "vin" : "432143124124E234", "tag" : "N12ABC", "state" : "FL", "odometer" : 78310, "fuelType" : "GAS", "rvInfo" : { "rvClass" : "A", "engineLocation" : "REAR", "gooseNeck" : false, "height" : 15.5, "length" : 24.2, "weight" : 1055, "towing" : false, "towingType" : "NOT TOWING" }, "trailerInfo" : { "axles" : 2, "condition" : "GOOD", "gooseNeck" : true, "hitchSize" : 3.5, "hitchType" : "BALL", "length" : 35.6, "loaded" : "????", "loadType" : "WATER", "loadWeight" : "1000", "plugType" : "7 PIN", "trailerType" : "5TH WHEEL" }, "specialEquipmentNeeds" : "NEED A BIG JACK" }, "service" : { "callType" : "MEMBER", "timezoneId" : "America/New_York", "timezoneOffset" : "UTC-07:00", "status" : { "status" : "SP", "modifiedDate" : "2018-09-15T10:05:21Z[UTC]", "eta" : "2018-09-15T10:05:41Z[UTC]", "pta" : "2018-09-15T10:05:51Z[UTC]", "waitTime" : 30 }, "appointmentTime" : "2018-09-15T10:05:51Z[UTC]", "facility" : { "foiType" : "ERS", "location" : { }, "id" : "9193", "name" : "BOBS TOWING ORLANDO SOUTH" }, "truck" : { "id" : "B1", "driver" : { "id" : "123", "contact" : { "contactType" : "DRIVER", "lastName" : "Truckdriver" } } }, "troubleCodes" : [ { "troubleCodeType" : "PACESETTER", "code" : "T680", "description" : "Engine Stalled While Driving" }, { "troubleCodeType" : "PACESETTER2", "code" : "T505", "description" : "L505 Parking Brake Wont Release" }, { "troubleCodeType" : "PROBLEM", "code" : "T6", "description" : "ENGINE STALLED" }, { "troubleCodeType" : "PROBLEM2", "code" : "T9", "description" : "PARKING BRAKE" } ], "serviceLocations" : [ { "serviceLocationType" : "BREAKDOWN", "foi" : { "foiType" : "ADDRESS", "location" : { "latitude" : 28.53349, "longitude" : -81.37751, "address" : { "addressType" : "PHYSICAL", "full" : "700 MAIN LANE, ORLANDO FL, 32801", "streetNumber" : "700", "streetDirection" : "SW", "streetName" : "MAIN LANE", "crossStreet" : "LUCERNE CIRCLE SW", "crossStreet2" : "HIGHWAY TO SOMEWHERE", "city" : "ORLANDO", "county" : "MONROE", "state" : "FL", "postalCode" : "32801", "country" : "UNITED STATES" }, "landmark" : "BOBS DINER", "highway" : "I-4", "mileMarker" : "47", "grid" : "B23", "zone" : "A1", "locationCode" : "BR" } }, "mileageCalculated" : 25, "driverDirections" : "GATECODE IS 12345" }, { "serviceLocationType" : "TOW_DESTINATION", "foi" : { "foiType" : "ADDRESS", "location" : { "latitude" : 26.98492, "longitude" : -82.10246, "address" : { "addressType" : "PHYSICAL", "full" : "3156 TAMIAMI TR, PORT CHARLOTTE, FL 33952", "streetNumber" : "3156", "streetName" : "TAMIAMI TR", "crossStreet" : "OCEAN BOULEVARD", "city" : "PORT CHARLOTTE", "county" : "PINELLAS", "state" : "FL", "postalCode" : "33952", "country" : "UNITED STATES" }, "landmark" : "AAR DON GASGARTHS CHARLOTTE CO FORD" }, "name" : "AAA DON GASGARTH CHARLOTTE CO FORD", "contacts" : [ { "contactType" : "TOWDEST", "firstName" : "BOB", "lastName" : "SHMOE", "phones" : [ { "phoneType" : "BUSINESS", "phoneNumber" : "8889996666", "preferred" : true } ] } ] }, "mileageCalculated" : 18, "dropBoxInfo" : "FACILITY DROPBOX IS LOCATED IN FRONT BY DOOR" } ], "collision" : false, "redFlag" : false, "priorityCode" : "P1", "legacyPriorityCode" : "P1", "numberOfPassengers" : 2, "needsFlatbed" : false, "flatbedRequested" : true, "policies" : [ { "code" : "POL1", "description" : "Service Policy1" } ], "providedServices" : [ { "providedServiceType" : "EXTRA CHARGE", "service" : "LONG TOW", "unit" : "MILES", "quantity" : 10, "charge" : { "chargeType" : "SERVICE_PROVIDED", "amount" : "5.00" } }, { "providedServiceType" : "", "service" : "GAS DELIVERY", "unit" : "GALLONS", "quantity" : 5 } ], "charges" : [ { "chargeType" : "GAS", "amount" : "10.00" } ] }, "payment" : { "required" : true, "paymentType" : "CREDIT", "codes" : "SOME PAYMENT CODES GO HERE" }, "comments" : [ { "system" : { "systemId" : "AAAD3Test", "systemOrganization" : { "name" : "AAA", "code" : "014" } }, "contact" : { "userId" : "ab5678", "contactType" : "AGENT" }, "commentDate" : "2018-09-15T10:05:20Z[UTC]", "commentType" : "CALL", "visibility" : "EXTERNAL", "text" : "THIS IS A COMMENT ABOUT THIS CALL VISIBLE TO ALL USERS" } ] } ] }';
            
            System.Test.setMock(HttpCalloutMock.class, new FSL_ToD3UpdateCalloutMockImpl(400, 'OK', body, responseHeaders));
            FSL_ToD3Update.makePostCallout( jsonReq, '45637', new Set<Id>{workOrderList[0].Id, workOrderList[0].id});            
            System.Test.StopTest();     
        }
    }
    
    /*static testMethod void responseWrapperTest(){
System.Test.StartTest();
Test.setMock(HttpCalloutMock.class, new FSL_WOJeopardy_MockResponseGenerator(false));  
FSL_ToD3Update.HeaderWrapper header = new FSL_ToD3Update.HeaderWrapper();
header.id = 'Test Id';
header.status = 'String';
header.subType = 'Test SubType';
header.version = 'v.1.0.0';
System.assert(header.id !=null);

FSL_ToD3Update.ResponseWrapper resWrapper = new FSL_ToD3Update.ResponseWrapper();
resWrapper.header = header;
resWrapper.statusCode = 200;
resWrapper.statusDescription = 'Successful';
System.Test.StopTest();     
}*/
    
    @testSetup
    public static void dataSetup() {
        FSL_DataFactoryUtility.userSetupwithStaticData();
        
    }
}